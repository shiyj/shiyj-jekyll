<!doctype html>
<html>
  <head>
  	<link rel="stylesheet" type="text/css" href="/css/application.css">
    <link rel="stylesheet" type="text/css" href="/css/main.css">
    <!--google analytics 谷歌分析代码-->
		<script type="text/javascript">
			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-23034032-1']);
			_gaq.push(['_trackPageview']);

			(function() {
				var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
				ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
				var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			})();
		</script>
    <link rel="alternate" type="application/atom+xml" title="spatialite c samples 解析（3） - feed" href="/index.xml" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <title>史英建的博客Engin's Blog _-_spatialite c samples 解析（3）</title>
  </head>
  <body>
  		
    <div id="container">
      <div id="header">
        <a  href="/"><h3>Shiyj is Talking </h3><img src="/images/ruby.png" height="100"></img></a>
        <ul>
          <li><a href="/" class="nav">首页</a></li>
          <li><a href="/archives.html" class="nav">日志列表</a></li>
          <li><a href="/tags" class = "nav">标签云</a></li>
          <li><a href="/about.html" class="page_link">关于我</a></li>
        </ul>
      </div>
      
     
			<div id="main" class="clearfix">
		    <div id="yieldfield">
		       <article class="post clearfix">
  <header class="post_header">
  <h3 class="post_title"><a href="/2011/11/16/spatialitecsample3.html">spatialite c samples 解析（3）</a></h3>
    <div class="post_info info">
      作者：<span class="post_at">史英建</span> | 
      发表于<span class="post_at">16 Nov 2011</span>
      标签：
      
      <a href="/tags/spatialite.html">spatialite</a>
      
    </div>
  </header>

  <section class="post_body body">
  <hr/>

<h2>spatialite c samples 解析（3）</h2>

<hr/>

<h3>1.创建空间数据库</h3>

<p>创建数据库和打开数据库使用同样的函数,只不过将参数改为可读写且能够创建(即不存在时可以重新创建一个数据库文件):</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    ret = sqlite3_open_v2 (argv[<span style="color:#00D">1</span>], &amp;handle,SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, <span style="color:#069">NULL</span>);
</pre></div>
</div>

<h4>1.1初始化空间要素</h4>

<p>spatialite提供一种初始化空间元数据的方法,执行下列语句即可:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> InitSpatialMetadata();
</pre></div>
</div>

<p>通过该方法创建的数据库表如下:</p>

<p><img src="/images/spatialite/inittree.png" alt="树状结构表"/></p>

<p>其执行的函数可以通过master中的内容看出:</p>

<p><img src="/images/spatialite/initmaster.png" alt="master图"/></p>

<p>上图表示执行&quot;SELECT InitSpatialMetadata();&quot;后所进行的操作包括:</p>

<ul>
<li>创建spatial<em>ref</em>sys表及其触发(trigger)规则;</li>
<li>创建geometry_columns表及其触发规则,并为之创建索引;</li>
<li>创建geom<em>cols</em>ref_sys视图.</li>
</ul>

<p>解释下触发(trigger)的含义及其在空间数据库中的作用.</p>

<p>触发即在执行数据库操作时需要执行的规则,这个规则可以是在执行前或后.</p>

<p>在此处的作用我们以具体的例子来说明:</p>

<p>本例中总共创建了三个触发规则:fkd<em>refsys</em>geocols,fki<em>geocols</em>refsys,fku<em>geocols</em>refsys.<br/>
触发名称的第三个字母分别表示:delete,insert和update,也就是说这三个触发是在执行删除、插入、更新时所触发的.<br/>
我们以fki<em>geocols</em>refsys为例看看究竟是什么规则:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">CREATE</span> <span style="color:#339;font-weight:bold">TRIGGER</span> fki_geocols_refsys <span style="color:#080;font-weight:bold">BEFORE</span> <span style="color:#B06;font-weight:bold">INSERT</span> <span style="color:#080;font-weight:bold">ON</span> geometry_columns
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>    <span style="color:#080;font-weight:bold">FOR</span> <span style="color:#080;font-weight:bold">EACH</span> <span style="color:#339;font-weight:bold">ROW</span> <span style="color:#B06;font-weight:bold">BEGIN</span>
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> RAISE(<span style="color:#B06;font-weight:bold">ROLLBACK</span>, 
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">insert on table ''geometry_columns'' violates constraint: ''spatial_ref_sys.srid''</span><span style="color:#710">'</span></span>)
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>    <span style="color:#080;font-weight:bold">WHERE</span>  NEW.<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">srid</span><span style="color:#710">&quot;</span></span> <span style="color:#080;font-weight:bold">IS</span> <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#069">NULL</span>
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>    <span style="color:#080;font-weight:bold">AND</span> (<span style="color:#B06;font-weight:bold">SELECT</span> srid <span style="color:#080;font-weight:bold">FROM</span> spatial_ref_sys <span style="color:#080;font-weight:bold">WHERE</span> srid = NEW.srid) <span style="color:#080;font-weight:bold">IS</span> <span style="color:#069">NULL</span>;
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>    <span style="color:#080;font-weight:bold">END</span>
</pre></div>
</div>

<p>很明显,这个触发器的意思是在向geometry<em>columns插入数据之前,如果新插入的数据中srid不是空,<br/>
并且spatial</em>ref_sys表中不存在新插入数据的srid值,那么就抛出错误终止查询操作.</p>

<p>通俗地讲,也就是说你向geometry<em>columns插入的srid值不是随便一个值,它必须是spatial</em>ref<em>sys中的一个.<br/>
或者可以理解为geometry</em>columns表对spatial<em>ref</em>sys有依赖.</p>

<p>关于初始化及触发的更多具体详细的细节请参考spatialite的教程文档.</p>

<h4>1.2插入基本的数据项,并创建空间数据表.</h4>

<p>在上一步创建的数据表spatial<em>ref</em>sys是空间数据所必需依赖的,我们要为之插入一个初始值.</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">INSERT</span> <span style="color:#B06;font-weight:bold">INTO</span> spatial_ref_sys 
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>        (srid, auth_name, auth_srid, ref_sys_name, proj4text)
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>        <span style="color:#080;font-weight:bold">VALUES</span> (<span style="color:#00D">3003</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">epsg</span><span style="color:#710">'</span></span>, <span style="color:#00D">3003</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Monte Mario / Italy zone 1</span><span style="color:#710">'</span></span>, 
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">+proj=tmerc +lat_0=0 +lon_0=9 +k=0.9996 +x_0=1500000 +y_0=0 +ellps=intl +units=m +no_defs</span><span style="color:#710">'</span></span>)
</pre></div>
</div>

<p>然后创建一个存放空间数据的数据表test:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">CREATE</span> <span style="color:#339;font-weight:bold">TABLE</span> test (PK <span style="color:#0a8;font-weight:bold">INTEGER</span> <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#069">NULL</span> <span style="color:#088;font-weight:bold">PRIMARY</span> <span style="color:#339;font-weight:bold">KEY</span>,name <span style="color:#0a8;font-weight:bold">VARCHAR</span>(<span style="color:#00D">6</span>))
</pre></div>
</div>

<p>spatialite提供创建空间数据项的的方法AddGeometryColumn();我们创建一个点要素:</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> AddGeometryColumn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">geom</span><span style="color:#710">'</span></span>, <span style="color:#00D">3003</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">POINT</span><span style="color:#710">'</span></span>, <span style="color:#00D">2</span>)
</pre></div>
</div>

<p>此方法只是创建了两个触发规则:ggi<em>test</em>geom,ggu<em>test</em>geom,不再细述.<br/>
插入数据</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">INSERT</span> <span style="color:#B06;font-weight:bold">INTO</span> test(name,geom) <span style="color:#080;font-weight:bold">VALUES</span> (<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">郑州</span><span style="color:#710">&quot;</span></span>,GeomFromText(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">POINT(117 34)</span><span style="color:#710">'</span></span>,<span style="color:#00D">4326</span>)
</pre></div>
</div>

<h3>2.空间索引</h3>

<h4>2.1创建空间索引:</h4>

<p>spatialite提供两种索引方法:R-Tree和MbrCache.</p>

<p>R-Tree:与我们平常所说的四叉树类似,但是对索引方法进行优化以适用空间数据的复杂性.具体表现在:1.尽可能包含多的目标,2.尽可能让矩形间少重叠.</p>

<p>Mbrcache实际上并不是索引,只是将数据存储在内存中,加快了读取速度.</p>

<h5>2.1.1R-Tree空间索引:</h5>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> CreateSpatialIndex(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">geom</span><span style="color:#710">'</span></span>)
</pre></div>
</div>

<p>该方法在master中的操作如下图所述,与上文所讲方法类似:<br/>
<img src="/images/spatialite/index.png" alt="空间索引"/><br/>
#####2.1.2MbrCache索引</p>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> CreateMbrCache(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">geom</span><span style="color:#710">'</span></span>)
</pre></div>
</div>

<p>该方法在master中的操作如下图所述,与上文所讲方法类似:<br/>
<img src="/images/spatialite/mbrcache.png" alt="mbrcache"/></p>

<h4>2.2空间查询</h4>

<p>空间索引只有在超大数据容量时才能显现其作用,我们先向其中插入<strong>100万</strong>个点数据.<br/>
在不同的空间索引下插入的速度和数据库大小也是不同的:</p>

<p><strong>没有构建索引直接插入: 34秒,70.5M</strong></p>

<p><strong>R-Tree索引:        136秒,120.3M</strong></p>

<p><strong>MbrCache索引:      47秒,70.5M</strong></p>

<p>从数据库的大小就可以看出:R-Tree在数据库中<strong>添加</strong>了一些东西,从上图可以看出,<br/>
Rtree添加了四个索引表idx_,而多出的50M容量就是建立的空间索引所占的容量.<br/>
相比之下,MbrCache的内容就基本上和没有索引一样.</p>

<p>至于<strong>查询速度</strong>,在有空间索引(无论R-Tree还是MbrCache)的情况下基本是0秒,<br/>
无索引则多达27秒.</p>

<h5>普通的查询方法:</h5>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> <span style="color:#369;font-weight:bold">Count</span>(*) <span style="color:#080;font-weight:bold">FROM</span> test 
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>        <span style="color:#080;font-weight:bold">WHERE</span> MbrWithin(geom, 
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>            BuildMbr(<span style="color:#60E">1000400.5</span>, <span style="color:#60E">4000400.5</span>,<span style="color:#60E">1000450.5</span>, <span style="color:#60E">4000450.5</span>))
</pre></div>
</div>

<h5>R-Tree索引法:</h5>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> <span style="color:#369;font-weight:bold">Count</span>(*) <span style="color:#080;font-weight:bold">FROM</span> test 
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>        <span style="color:#080;font-weight:bold">WHERE</span> MbrWithin(geom, BuildMbr(<span style="color:#60E">1000400.5</span>, <span style="color:#60E">4000400.5</span>,<span style="color:#60E">1000450.5</span>, <span style="color:#60E">4000450.5</span>))
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>        <span style="color:#080;font-weight:bold">AND</span> ROWID <span style="color:#080;font-weight:bold">IN</span> ( <span style="color:#B06;font-weight:bold">SELECT</span> pkid <span style="color:#080;font-weight:bold">FROM</span> idx_test_geom 
<span class="line-numbers"><a href="#n4" name="n4">4</a></span>                                        <span style="color:#080;font-weight:bold">WHERE</span>  xmin &gt; <span style="color:#60E">1000400.5</span> 
<span class="line-numbers"><a href="#n5" name="n5">5</a></span>                                        <span style="color:#080;font-weight:bold">AND</span> xmax &lt; <span style="color:#60E">1000450.5</span> 
<span class="line-numbers"><a href="#n6" name="n6">6</a></span>                                        <span style="color:#080;font-weight:bold">AND</span> ymin &gt; <span style="color:#60E">4000400.5</span> 
<span class="line-numbers"><a href="#n7" name="n7">7</a></span>                                        <span style="color:#080;font-weight:bold">AND</span> ymax &lt; <span style="color:#60E">4000450.5</span>)
</pre></div>
</div>

<h5>MbrCache法:</h5>
<div class="CodeRay">
  <div class="code"><pre><span class="line-numbers"><a href="#n1" name="n1">1</a></span>    <span style="color:#B06;font-weight:bold">SELECT</span> <span style="color:#369;font-weight:bold">Count</span>(*) <span style="color:#080;font-weight:bold">FROM</span> test 
<span class="line-numbers"><a href="#n2" name="n2">2</a></span>        <span style="color:#080;font-weight:bold">WHERE</span> ROWID <span style="color:#080;font-weight:bold">IN</span> (<span style="color:#B06;font-weight:bold">SELECT</span> rowid <span style="color:#080;font-weight:bold">FROM</span> cache_test_geom 
<span class="line-numbers"><a href="#n3" name="n3">3</a></span>            <span style="color:#080;font-weight:bold">WHERE</span> mbr = FilterMbrWithin(<span style="color:#60E">1000400.5</span>,<span style="color:#60E">4000400.5</span>,<span style="color:#60E">1000450.5</span>,<span style="color:#60E">4000450.5</span>))
</pre></div>
</div>

<p>Powered by <a href="/about">Engin</a> &amp; toto</p>

  </section>
  <section id="comment_form" class="comment_form clearfix">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'enginblog'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
</article>


		    </div>
				<div id="webleft">
					<embed src="/images/time.swf" wmode="transparent" width="200px" height="100px"></embed>
          <iframe frameborder="0" scrolling="no" src="http://v.t.qq.com/show/show.php?n=giszzu&w=202&h=452&fl=1&l=2&o=29&c=1&si=e9d8d3d76e7861abaf728b6778b40fc997220bc8" width="202" height="452">
          </iframe>
        </div>
			</div>
      <div id="footer" class="clearfix">
        &copy; <a href="http://about.me/shiyj">史英建</a> | <a href="http://github.com/shiyj">源代码</a>|<a href="/about.html">关于我</a>
      </div>

    </div>
  </body>
</html>

